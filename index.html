<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FLOW-CHAT - Interactive Flow REPL</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: #0a0a0a;
      color: #0f0;
      font-family: "Fira Code", "Cascadia Code", "JetBrains Mono", "SF Mono", monospace;
      font-size: 14px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ---- Header ---- */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background: #111;
      border-bottom: 1px solid #1a3a1a;
    }

    header h1 {
      font-size: 18px;
      letter-spacing: 3px;
      color: #0f0;
      text-shadow: 0 0 8px #0f04;
    }

    #status {
      font-size: 12px;
      color: #555;
    }

    #status.connected {
      color: #0f0;
    }

    /* ---- Main Split ---- */
    .split {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #1a3a1a;
      min-width: 0;
    }

    .pane:last-child {
      border-right: none;
    }

    .pane-header {
      padding: 8px 16px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 2px;
      background: #0e0e0e;
      border-bottom: 1px solid #1a3a1a;
      color: #0a0;
      user-select: none;
    }

    /* ---- Input Pane ---- */
    #flow-input {
      flex: 1;
      background: transparent;
      color: #0f0;
      border: none;
      outline: none;
      resize: none;
      padding: 16px;
      font-family: inherit;
      font-size: 14px;
      line-height: 1.6;
    }

    #flow-input::placeholder {
      color: #1a4a1a;
    }

    .input-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: #0e0e0e;
      border-top: 1px solid #1a3a1a;
    }

    button {
      background: #0f0;
      color: #0a0a0a;
      border: none;
      padding: 6px 18px;
      font-family: inherit;
      font-size: 12px;
      font-weight: bold;
      letter-spacing: 1px;
      cursor: pointer;
      text-transform: uppercase;
    }

    button:hover {
      background: #0c0;
    }

    button:active {
      background: #090;
    }

    .hint {
      font-size: 11px;
      color: #333;
    }

    /* ---- Output Pane ---- */
    #output-log {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .entry {
      border: 1px solid #1a3a1a;
      background: #0c0c0c;
    }

    .entry-section {
      padding: 10px 14px;
    }

    .entry-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #060;
      margin-bottom: 6px;
    }

    .entry-cpp {
      border-bottom: 1px solid #1a3a1a;
    }

    .entry-cpp pre {
      color: #0d0;
      white-space: pre-wrap;
      word-break: break-all;
      line-height: 1.5;
    }

    .entry-output pre {
      color: #0f0;
      white-space: pre-wrap;
      word-break: break-all;
      line-height: 1.5;
    }

    .entry-output.error pre {
      color: #f44;
    }

    .entry-timestamp {
      font-size: 10px;
      color: #333;
      padding: 4px 14px;
      border-top: 1px solid #1a3a1a;
      text-align: right;
    }

    .info-message {
      color: #555;
      font-style: italic;
      font-size: 12px;
    }

    /* ---- Scrollbar ---- */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #0a0a0a;
    }

    ::-webkit-scrollbar-thumb {
      background: #1a3a1a;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #2a5a2a;
    }
  </style>
</head>
<body>
  <header>
    <h1>FLOW-CHAT - Interactive Flow REPL</h1>
    <span id="status">disconnected</span>
  </header>

  <div class="split">
    <!-- Left: Flow Input -->
    <div class="pane">
      <div class="pane-header">Flow Input</div>
      <textarea
        id="flow-input"
        placeholder='Type Flow code here...&#10;&#10;Examples:&#10;  say "hello world"&#10;  let x = 42&#10;  say x&#10;  loop 3 { std::cout << "hi" << std::endl; }'
        spellcheck="false"
        autofocus
      ></textarea>
      <div class="input-controls">
        <button id="send-btn">Compile &amp; Run</button>
        <span class="hint">Ctrl+Enter to send</span>
      </div>
    </div>

    <!-- Right: C++ Output + Execution Result -->
    <div class="pane">
      <div class="pane-header">C++ Output / Execution</div>
      <div id="output-log"></div>
    </div>
  </div>

  <script>
    const input    = document.getElementById("flow-input");
    const sendBtn  = document.getElementById("send-btn");
    const output   = document.getElementById("output-log");
    const statusEl = document.getElementById("status");

    let ws = null;

    function connect() {
      const proto = location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${proto}://${location.host}`);

      ws.addEventListener("open", () => {
        statusEl.textContent = "connected";
        statusEl.className   = "connected";
      });

      ws.addEventListener("close", () => {
        statusEl.textContent = "disconnected";
        statusEl.className   = "";
        // Reconnect after a short delay
        setTimeout(connect, 2000);
      });

      ws.addEventListener("error", () => {
        statusEl.textContent = "error";
        statusEl.className   = "";
      });

      ws.addEventListener("message", (event) => {
        let data;
        try {
          data = JSON.parse(event.data);
        } catch {
          return;
        }

        if (data.type === "info") {
          appendInfo(data.message);
          return;
        }

        if (data.type === "compiled") {
          appendResult(data);
          return;
        }
      });
    }

    function appendInfo(message) {
      const div = document.createElement("div");
      div.className = "info-message";
      div.textContent = message;
      output.appendChild(div);
      output.scrollTop = output.scrollHeight;
    }

    function appendResult(data) {
      const entry = document.createElement("div");
      entry.className = "entry";

      // C++ section
      const cppSection = document.createElement("div");
      cppSection.className = "entry-section entry-cpp";
      const cppLabel = document.createElement("div");
      cppLabel.className = "entry-label";
      cppLabel.textContent = "Generated C++";
      const cppPre = document.createElement("pre");
      cppPre.textContent = data.cpp;
      cppSection.appendChild(cppLabel);
      cppSection.appendChild(cppPre);
      entry.appendChild(cppSection);

      // Output section
      const outSection = document.createElement("div");
      outSection.className = "entry-section entry-output" + (data.compiled ? "" : " error");
      const outLabel = document.createElement("div");
      outLabel.className = "entry-label";
      outLabel.textContent = data.compiled ? "Execution Output" : "Error";
      const outPre = document.createElement("pre");
      outPre.textContent = data.output;
      outSection.appendChild(outLabel);
      outSection.appendChild(outPre);
      entry.appendChild(outSection);

      // Timestamp
      if (data.timestamp) {
        const tsDiv = document.createElement("div");
        tsDiv.className = "entry-timestamp";
        tsDiv.textContent = new Date(data.timestamp).toLocaleTimeString();
        entry.appendChild(tsDiv);
      }

      output.appendChild(entry);
      output.scrollTop = output.scrollHeight;
    }

    function send() {
      const code = input.value.trim();
      if (!code || !ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(code);
    }

    sendBtn.addEventListener("click", send);

    input.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.key === "Enter") {
        e.preventDefault();
        send();
      }
    });

    connect();
  </script>
</body>
</html>
